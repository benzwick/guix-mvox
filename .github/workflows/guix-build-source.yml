name: Guix Build from Source

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1'

jobs:
  build:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 120
    strategy:
      matrix:
        os: [ubuntu-24.04, ubuntu-latest]

    steps:
    - uses: actions/checkout@v4

    - name: Get cache key
      id: cache-key
      run: echo "week=$(date +%G-W%V)" >> $GITHUB_OUTPUT

    # Install Guix using the official install script, which sets up an
    # unprivileged daemon via systemd (no build users or chroot needed).
    # https://guix.gnu.org/manual/1.5.0/en/html_node/Binary-Installation.html
    # https://hpc.guix.info/blog/2025/03/build-daemon-drops-its-privileges/
    - name: Install Guix
      run: |
        wget -qO /tmp/guix-install.sh https://guix.gnu.org/install.sh
        chmod +x /tmp/guix-install.sh
        yes | sudo /tmp/guix-install.sh
        echo "/var/guix/profiles/per-user/root/current-guix/bin" >> $GITHUB_PATH
        echo "LANG=en_US.utf8" >> $GITHUB_ENV

    - name: Restore Guix store cache
      uses: actions/cache/restore@v4
      with:
        path: |
          /gnu/store
          /var/guix
          ~/.cache/guix
        key: guix-${{ matrix.os }}-${{ steps.cache-key.outputs.week }}-${{ github.run_number }}
        restore-keys: guix-${{ matrix.os }}-${{ steps.cache-key.outputs.week }}-

    # The install script ships a release tarball; update to latest so
    # it can build current packages and compile channel modules.
    # https://guix.gnu.org/manual/1.5.0/en/html_node/Upgrading-Guix.html
    # Guix migrated from git.guix.gnu.org to Codeberg; the new URL
    # requires an explicit introduction for channel authentication.
    # https://guix.gnu.org/blog/2025/migrating-to-codeberg/
    - name: Update Guix
      run: |
        mkdir -p ~/.config/guix
        cat > ~/.config/guix/channels.scm << 'EOF'
        (list (channel
                (name 'guix)
                (url "https://codeberg.org/guix/guix.git")
                (branch "master")
                (introduction
                  (make-channel-introduction
                    "9edb3f66fd807b096b48283debdcddccfea34bad"
                    (openpgp-fingerprint
                      "BBB0 2DDF 2CEA F6A8 0D1D  E643 A2A0 6DF2 A33A 54FA")))))
        EOF
        guix pull
        echo "$HOME/.config/guix/current/bin" >> $GITHUB_PATH

    - name: Clone mvox
      uses: actions/checkout@v4
      with:
        repository: benzwick/mvox
        path: mvox-src

    # guix shell -D sets GUIX_ENVIRONMENT to the profile containing all
    # build inputs, but does not set CMAKE_PREFIX_PATH (cmake defines it
    # as a native-search-path, which only activates during guix build).
    # Pass it explicitly so cmake can find ITK and MFEM.
    - name: Configure mvox
      run: guix shell -D -L . mvox -- bash -c 'cmake -B build -S mvox-src -DCMAKE_PREFIX_PATH="$GUIX_ENVIRONMENT"'

    - name: Build mvox
      run: guix shell -D -L . mvox -- make -C build -j$(nproc)

    - name: Smoke test
      run: guix shell -D -L . mvox -- ./build/mvox --help || test $? -eq 1

    - name: Test boxmesh
      working-directory: mvox-src/examples
      run: guix shell -D -L "$GITHUB_WORKSPACE" mvox -- bash boxmesh.sh

    - name: Test brain-tensors
      working-directory: mvox-src/examples
      run: guix shell -D -L "$GITHUB_WORKSPACE" mvox -- bash brain-tensors.sh

    - name: Stop Guix daemon
      if: always()
      run: sudo systemctl stop guix-daemon

    - name: Save Guix store cache
      uses: actions/cache/save@v4
      if: always()
      with:
        path: |
          /gnu/store
          /var/guix
          ~/.cache/guix
        key: guix-${{ matrix.os }}-${{ steps.cache-key.outputs.week }}-${{ github.run_number }}
