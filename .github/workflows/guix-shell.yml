name: Guix Shell

# Build mvox from source inside a Guix development environment.
#
# Runs "guix shell -D mvox" to provide all build dependencies
# (MFEM, ITK, cmake, etc.), then builds with cmake and make.
# This is how a developer would build mvox locally.

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1'

jobs:
  build:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 120
    strategy:
      matrix:
        os: [ubuntu-24.04, ubuntu-latest]

    steps:
    - uses: actions/checkout@v4

    - name: Install Guix
      run: |
        sudo apt-get update
        sudo apt-get install -y guix
        echo "LANG=en_US.utf8" >> $GITHUB_ENV

    # Guix migrated from git.guix.gnu.org to Codeberg; the new URL
    # requires an explicit introduction for channel authentication.
    # https://guix.gnu.org/blog/2025/migrating-to-codeberg/
    - name: Configure channels
      run: |
        mkdir -p ~/.config/guix
        cat > ~/.config/guix/channels.scm << 'EOF'
        (list (channel
                (name 'guix)
                (url "https://codeberg.org/guix/guix.git")
                (branch "master")
                (introduction
                  (make-channel-introduction
                    "9edb3f66fd807b096b48283debdcddccfea34bad"
                    (openpgp-fingerprint
                      "BBB0 2DDF 2CEA F6A8 0D1D  E643 A2A0 6DF2 A33A 54FA")))))
        EOF

    # The apt package ships an older Guix; update to latest so it can
    # build current packages and compile channel modules.
    # https://guix.gnu.org/manual/en/html_node/Upgrading-Guix.html
    - name: Update Guix
      run: |
        guix pull
        echo "$HOME/.config/guix/current/bin" >> $GITHUB_PATH

    - name: Lint packages
      continue-on-error: true
      run: guix lint -L . mfem mfem-4.5 mvox mvox-mfem-4.5

    - name: Clone mvox
      uses: actions/checkout@v4
      with:
        repository: benzwick/mvox
        path: mvox-src

    # Each build step runs inside "guix shell --pure -D" so that all
    # search paths (CMAKE_PREFIX_PATH, LIBRARY_PATH, etc.) are set
    # correctly and system paths don't interfere. The store is populated
    # on the first invocation; subsequent calls reuse the cached profile
    # and are fast.
    # CMAKE_INSTALL_RPATH_USE_LINK_PATH preserves Guix store library
    # paths in installed binaries. Without this, cmake strips rpath on
    # install and the binary cannot find shared libraries. Guix's own
    # cmake-build-system handles this via its fix-runpath phase, but
    # that phase is not available when building manually in guix shell.
    - name: Configure mvox
      run: guix shell --pure -L . -D mvox -- cmake -B build -S mvox-src -DCMAKE_INSTALL_RPATH_USE_LINK_PATH=ON

    - name: Build mvox
      run: guix shell --pure -L . -D mvox -- make -C build -j$(nproc)

    - name: Install mvox
      run: guix shell --pure -L . -D mvox -- cmake --install build --prefix install

    - name: Smoke test (installed)
      run: guix shell --pure -L . -D mvox -- bash -c './install/bin/mvox --help || test $? -eq 1'

    # The example scripts use wget and expect mvox on PATH.
    # Add wget to the shell and prepend the local install prefix.
    - name: Test boxmesh
      run: guix shell --pure -L . -D mvox wget -- bash -c 'export PATH=$PWD/install/bin:$PATH && cd mvox-src/examples && bash boxmesh.sh'

    - name: Test brain-tensors
      run: guix shell --pure -L . -D mvox wget -- bash -c 'export PATH=$PWD/install/bin:$PATH && cd mvox-src/examples && bash brain-tensors.sh'

    - name: Collect Guix build logs
      if: always()
      run: |
        mkdir -p guix-build-logs
        for f in /var/log/guix/drvs/*/*; do
          sudo cp "$f" guix-build-logs/ || true
        done
        gunzip guix-build-logs/*.gz 2>/dev/null || true

    - name: Upload Guix build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: guix-build-logs-${{ matrix.os }}
        path: guix-build-logs/

    - name: Stop Guix daemon
      if: always()
      run: sudo systemctl stop guix-daemon
