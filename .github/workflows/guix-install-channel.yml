name: Guix Install (channel)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1'

jobs:
  build:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 120
    strategy:
      matrix:
        os: [ubuntu-22.04, ubuntu-latest]

    steps:
    - name: Get cache key
      id: cache-key
      run: echo "week=$(date +%G-W%V)" >> $GITHUB_OUTPUT

    - name: Install Guix
      run: |
        # Download and extract Guix binary
        wget -qO guix-binary.tar.xz "https://ci.guix.gnu.org/search/latest/archive?query=spec:tarball+status:success+system:x86_64-linux+guix-binary.tar.xz"
        sudo tar xf guix-binary.tar.xz -C / --no-overwrite-dir

        # Create build users
        sudo groupadd --system guixbuild
        for i in $(seq -w 1 10); do
          sudo useradd -g guixbuild -G guixbuild -d /var/empty \
            -s "$(which nologin)" -c "Guix build user $i" \
            --system "guixbuilder${i}"
        done

        # Authorize substitutes
        for f in /var/guix/profiles/per-user/root/current-guix/share/guix/*.pub; do
          sudo /var/guix/profiles/per-user/root/current-guix/bin/guix archive --authorize < "$f"
        done

        # Add guix to PATH
        export GUIX_PATH=/var/guix/profiles/per-user/root/current-guix
        echo "$GUIX_PATH/bin" >> $GITHUB_PATH
        echo "LANG=en_US.utf8" >> $GITHUB_ENV

    - name: Restore Guix store cache
      uses: actions/cache/restore@v4
      with:
        path: |
          /gnu/store
          /var/guix
          ~/.cache/guix
        key: guix-${{ matrix.os }}-${{ steps.cache-key.outputs.week }}-${{ github.run_number }}
        restore-keys: guix-${{ matrix.os }}-${{ steps.cache-key.outputs.week }}-

    - name: Start Guix daemon
      run: |
        sudo /var/guix/profiles/per-user/root/current-guix/bin/guix-daemon \
          --build-users-group=guixbuild --disable-chroot &

    # Guix migrated from git.guix.gnu.org to Codeberg; the new URL
    # requires an explicit introduction for channel authentication.
    # https://guix.gnu.org/blog/2025/migrating-to-codeberg/
    - name: Configure channel
      run: |
        mkdir -p ~/.config/guix
        cat > ~/.config/guix/channels.scm << 'EOF'
        (cons* (channel
                 (name 'guix)
                 (url "https://codeberg.org/guix/guix.git")
                 (branch "master")
                 (introduction
                   (make-channel-introduction
                     "9edb3f66fd807b096b48283debdcddccfea34bad"
                     (openpgp-fingerprint
                       "BBB0 2DDF 2CEA F6A8 0D1D  E643 A2A0 6DF2 A33A 54FA"))))
               (channel
                 (name 'mvox)
                 (url "https://github.com/benzwick/guix-mvox")
                 (branch "main"))
               %default-channels)
        EOF

    # guix pull updates Guix itself and pulls the mvox channel.
    # Add the updated guix to PATH for subsequent steps.
    - name: Pull
      run: |
        guix pull
        echo "$HOME/.config/guix/current/bin" >> $GITHUB_PATH

    - name: Install mvox
      run: guix install mvox

    # guix install puts binaries in ~/.guix-profile/bin. On a normal
    # system, sourcing ~/.guix-profile/etc/profile adds it to PATH.
    # GitHub Actions steps run non-login shells, so add it explicitly.
    # https://guix.gnu.org/manual/1.5.0/en/html_node/Getting-Started.html
    - name: Add Guix profile to PATH
      run: echo "$HOME/.guix-profile/bin" >> $GITHUB_PATH

    - name: Smoke test
      run: mvox --help || test $? -eq 1

    - name: Clone mvox for tests
      uses: actions/checkout@v4
      with:
        repository: benzwick/mvox
        path: mvox-src

    - name: Test boxmesh
      working-directory: mvox-src/examples
      run: bash boxmesh.sh

    - name: Test brain-tensors
      working-directory: mvox-src/examples
      run: bash brain-tensors.sh

    - name: Stop Guix daemon
      if: always()
      run: sudo pkill guix-daemon || true

    - name: Save Guix store cache
      uses: actions/cache/save@v4
      if: always()
      with:
        path: |
          /gnu/store
          /var/guix
          ~/.cache/guix
        key: guix-${{ matrix.os }}-${{ steps.cache-key.outputs.week }}-${{ github.run_number }}
